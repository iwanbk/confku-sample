function trace(a){"\n"==a[a.length-1]&&(a=a.substring(0,a.length-1)),console.log((performance.now()/1e3).toFixed(3)+": "+a)}function checkCompatibility(){return RTCPeerConnection?!0:!1}(function(){"use strict";function a(){}function b(a,b){for(var c=a.length;c--;)if(a[c].listener===b)return c;return-1}function c(a){return function(){return this[a].apply(this,arguments)}}var d=a.prototype;d.getListeners=function(a){var b,c,d=this._getEvents();if("object"==typeof a){b={};for(c in d)d.hasOwnProperty(c)&&a.test(c)&&(b[c]=d[c])}else b=d[a]||(d[a]=[]);return b},d.flattenListeners=function(a){var b,c=[];for(b=0;b<a.length;b+=1)c.push(a[b].listener);return c},d.getListenersAsObject=function(a){var b,c=this.getListeners(a);return c instanceof Array&&(b={},b[a]=c),b||c},d.addListener=function(a,c){var d,e=this.getListenersAsObject(a),f="object"==typeof c;for(d in e)e.hasOwnProperty(d)&&-1===b(e[d],c)&&e[d].push(f?c:{listener:c,once:!1});return this},d.on=c("addListener"),d.addOnceListener=function(a,b){return this.addListener(a,{listener:b,once:!0})},d.once=c("addOnceListener"),d.defineEvent=function(a){return this.getListeners(a),this},d.defineEvents=function(a){for(var b=0;b<a.length;b+=1)this.defineEvent(a[b]);return this},d.removeListener=function(a,c){var d,e,f=this.getListenersAsObject(a);for(e in f)f.hasOwnProperty(e)&&(d=b(f[e],c),-1!==d&&f[e].splice(d,1));return this},d.off=c("removeListener"),d.addListeners=function(a,b){return this.manipulateListeners(!1,a,b)},d.removeListeners=function(a,b){return this.manipulateListeners(!0,a,b)},d.manipulateListeners=function(a,b,c){var d,e,f=a?this.removeListener:this.addListener,g=a?this.removeListeners:this.addListeners;if("object"!=typeof b||b instanceof RegExp)for(d=c.length;d--;)f.call(this,b,c[d]);else for(d in b)b.hasOwnProperty(d)&&(e=b[d])&&("function"==typeof e?f.call(this,d,e):g.call(this,d,e));return this},d.removeEvent=function(a){var b,c=typeof a,d=this._getEvents();if("string"===c)delete d[a];else if("object"===c)for(b in d)d.hasOwnProperty(b)&&a.test(b)&&delete d[b];else delete this._events;return this},d.removeAllListeners=c("removeEvent"),d.emitEvent=function(a,b){var c,d,e,f,g=this.getListenersAsObject(a);for(e in g)if(g.hasOwnProperty(e))for(d=g[e].length;d--;)c=g[e][d],c.once===!0&&this.removeListener(a,c.listener),f=c.listener.apply(this,b||[]),f===this._getOnceReturnValue()&&this.removeListener(a,c.listener);return this},d.trigger=c("emitEvent"),d.emit=function(a){var b=Array.prototype.slice.call(arguments,1);return this.emitEvent(a,b)},d.setOnceReturnValue=function(a){return this._onceReturnValue=a,this},d._getOnceReturnValue=function(){return this.hasOwnProperty("_onceReturnValue")?this._onceReturnValue:!0},d._getEvents=function(){return this._events||(this._events={})},"function"==typeof define&&define.amd?define(function(){return a}):"object"==typeof module&&module.exports?module.exports=a:this.EventEmitter=a}).call(this);var RTCPeerConnection=null,getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null,webrtcDetectedVersion=null;navigator.mozGetUserMedia?(console.log("This appears to be Firefox"),webrtcDetectedBrowser="firefox",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]),RTCPeerConnection=mozRTCPeerConnection,RTCSessionDescription=mozRTCSessionDescription,RTCIceCandidate=mozRTCIceCandidate,getUserMedia=navigator.mozGetUserMedia.bind(navigator),createIceServer=function(a,b,c){var d=null,e=a.split(":");if(0===e[0].indexOf("stun"))d={url:a};else if(0===e[0].indexOf("turn")&&(-1!==a.indexOf("transport=udp")||-1===a.indexOf("?transport"))){var f=a.split("?");d={url:f[0],credential:c,username:b}}return d},attachMediaStream=function(a,b){console.log("Attaching media stream"),a.mozSrcObject=b,a.play()},reattachMediaStream=function(a,b){console.log("Reattaching media stream"),a.mozSrcObject=b.mozSrcObject,a.play()},MediaStream.prototype.getVideoTracks=function(){return[]},MediaStream.prototype.getAudioTracks=function(){return[]}):navigator.webkitGetUserMedia?(console.log("This appears to be Chrome"),webrtcDetectedBrowser="chrome",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2]),createIceServer=function(a,b,c){var d=null,e=a.split(":");if(0===e[0].indexOf("stun"))d={url:a};else if(0===e[0].indexOf("turn"))if(28>webrtcDetectedVersion){var f=a.split("turn:");d={url:"turn:"+b+"@"+f[1],credential:c}}else d={url:a,credential:c,username:b};return d},RTCPeerConnection=webkitRTCPeerConnection,getUserMedia=navigator.webkitGetUserMedia.bind(navigator),attachMediaStream=function(a,b){"undefined"!=typeof a.srcObject?a.srcObject=b:"undefined"!=typeof a.mozSrcObject?a.mozSrcObject=b:"undefined"!=typeof a.src?a.src=URL.createObjectURL(b):console.log("Error attaching stream to element.")},reattachMediaStream=function(a,b){a.src=b.src},webkitMediaStream.prototype.getVideoTracks||(webkitMediaStream.prototype.getVideoTracks=function(){return this.videoTracks},webkitMediaStream.prototype.getAudioTracks=function(){return this.audioTracks}),webkitRTCPeerConnection.prototype.getLocalStreams||(webkitRTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams},webkitRTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams})):console.log("Browser does not appear to be WebRTC-capable");var CONFKU_DEFAULT_WSHOST="localhost",CONFKU_DEFAULT_WSPORT="8001",CONFKU_DEFAULT_ROOM="",confku={localVideo:null,iceServers:"stun:stun.l.google.com:19302",ee:new EventEmitter,conns:{},myPeerId:null,myStream:null,hubHost:null,hubPort:null,room:null,name:null,isWsConnOpened:!1,isGetusermedia:!1,isGetPeers:!1},sdpConstraints={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}};confku.NewConn=function(a,b){console.log("New Peer = "+b);var c={pc:null,peerId:a,name:b,stream:null};return c},confku.init=function(a,b,c,d){return checkCompatibility()?(confku.room=c||CONFKU_DEFAULT_ROOM,confku.hubHost=a||CONFKU_DEFAULT_WSHOST,confku.hubPort=b||CONFKU_DEFAULT_WSPORT,confku.name=d||"",console.info("initializing confku.hub host ="+confku.hubHost+".hub port = "+confku.hubPort+".room = "+c),this.localVideo=document.getElementById("localVideo"),this.getUserMedia(),this.wsConnect(),!0):(console.info("browser is not supported"),!1)},confku.numPeers=function(){return Object.keys(confku.conns).length},confku.wsConnect=function(){var a=this,b="ws://"+confku.hubHost+":"+confku.hubPort;console.log("connect to ws="+b),this.socket=new WebSocket(b),this.socket.onopen=function(){console.log("connection to server opened"),confku.ee.trigger("wsconnopened")},this.socket.onclose=function(){console.log("connection to server closed")},this.socket.onerror=function(a){console.log("ws connection to server error:"+a)},this.socket.onmessage=function(b){var c=JSON.parse(b.data);a.ee.trigger(c.eventName,[c.data])}},confku.getUserMedia=function(){var a=this,b=function(a){console.error("onUserMediaFailed = "+a)},c=function(b){console.log("onUserMediaSuccess"),confku.myStream=b,attachMediaStream(a.localVideo,b),a.ee.trigger("getusermedia_success")};getUserMedia({video:!0,audio:!0},c,b)},confku.createPC=function(a){console.log("create Peer Connection for id = "+a);var b={};b.optional=[],b.optional.push({DtlsSrtpKeyAgreement:"true"});var c={iceServers:[{url:this.iceServers}]},d=this.conns[a].pc=new RTCPeerConnection(c,b),e=this;return d.onopen=function(){console.log("pc onopen")},d.onicecandidate=function(b){if(b.candidate){var c={eventName:"ice_candidate",data:{label:b.candidate.sdpMLineIndex,candidate:b.candidate.candidate,peerIdDest:a,peerIdSrc:confku.myPeerId}};e.socket.send(JSON.stringify(c))}else console.log("end of candidate")},d.onaddstream=function(b){console.log("pc on add stream"),e.ee.trigger("add_remote_stream",[b.stream,a])},d},confku.sendOffer=function(a){console.log("sendOffer()");var b=this.conns[a].pc,c=function(c){var d=function(){console.log("set local session description OK")},e=function(a){console.log("set local sess description failed :"+a.toString())};b.setLocalDescription(c,d,e);var f={eventName:"offer",data:{peerIdDest:a,peerIdSrc:confku.myPeerId,sdp:c}};confku.socket.send(JSON.stringify(f))},d=function(a){console.log("onCreateSessionDesc error:"+a)};b.createOffer(c,d,sdpConstraints)},confku.recvChanOnMessage=function(a){console.log("recvChanOnMessage data = "+a.data)},confku.recvChanOnStateChange=function(){var a=confku.recvChan.readyState;console.log("Receive channel state is: "+a)},confku.recvChanCb=function(a){console.log("pc on data channel"),confku.recvChan=a.channel,confku.recvChan.onmessage=confku.recvChanOnMessage,confku.recvChan.onclose=confku.recvChanOnStateChange,confku.recvChan.onopen=confku.recvChanOnStateChange},confku.createDC=function(a){var b={reliable:!0},c=confku.conns[a].pc;console.log("create Data channel to "+a);var d=confku.conns[a].dc=c.createDataChannel("dataChannel",b);c.ondatachannel=confku.recvChanCb,d.onopen=function(){console.log("DC Open brow")}},confku.setupConns=function(){console.log("setup Conns");for(var a in this.conns){var b=this.createPC(a);b.addStream(confku.myStream),this.sendOffer(a)}},confku.sendAnswer=function(a){console.log("sendAnswer()");var b=this.conns[a].pc,c=function(c){b.setLocalDescription(c);var d={eventName:"answer",data:{peerIdDest:a,peerIdSrc:confku.myPeerId,sdp:c}};confku.socket.send(JSON.stringify(d)),console.log("sending answer...")},d=function(a){console.error("sendAnswer(). Create answer failed:"+a.toString())};b.createAnswer(c,d,sdpConstraints)},confku.joinRoom=function(){var a=JSON.stringify({eventName:"join_room",data:{name:confku.name,room:confku.room}});confku.socket.send(a)},confku.ee.on("wsconnopened",function(){console.log("on wsconnopened"),confku.isWsConnOpened=!0,confku.isGetusermedia&&confku.joinRoom()}),confku.ee.on("getusermedia_success",function(){console.log("on getusermedia_success"),confku.isGetusermedia=!0,confku.isWsConnOpened&&confku.joinRoom(),confku.isGetPeers&&confku.setupConns()}),confku.ee.on("join_room_ok",function(a){console.log("join room "+a.room_name+" OK. peerId = "+a.peerId),confku.myPeerId=a.peerId}),confku.ee.on("get_peers",function(a){console.log("on get peers"),confku.isGetPeers=!0;for(var b=0;b<a.peers.length;b++){var c=a.peers[b].peerId,d=a.peers[b].name;confku.conns[c]=confku.NewConn(c,d)}confku.isGetusermedia&&confku.setupConns()}),confku.ee.on("peer_join_room",function(a){console.log("on peer_join_room:"+a.peerId),confku.conns[a.peerId]=confku.NewConn(a.peerId,a.name);var b=confku.createPC(a.peerId);b.addStream(confku.myStream)}),confku.ee.on("peer_leave_room",function(a){console.log("on peer_leave_room:"+a.peerId),delete confku.conns[a.peerId],confkuUI.removeVideo(a.peerId)}),confku.ee.on("answer",function(a){console.log("on answer");var b=confku.conns[a.peerIdSrc].pc,c=function(){console.log("Set session description success")},d=function(a){console.warn("Failed to set session description : "+a.toString())};b.setRemoteDescription(new RTCSessionDescription(a.sdp),c,d)}),confku.ee.on("offer",function(a){console.log("on offer");var b=confku.conns[a.peerIdSrc].pc,c=function(){console.log("Receive offer. Set remote description OK"),confku.sendAnswer(a.peerIdSrc)},d=function(a){console.error("Receive offer. set remote description failed:"+a.toString())};b.setRemoteDescription(new RTCSessionDescription(a.sdp),c,d)}),confku.ee.on("ice_candidate",function(a){console.log("on ice_candidate");var b=new RTCIceCandidate({candidate:a.candidate,sdpMLineIndex:a.label});confku.conns[a.peerIdSrc].pc.addIceCandidate(b)}),confku.ee.on("add_remote_stream",function(a,b){console.log("on add_remote_stream");var c=confkuUI.addVideo(a,b);attachMediaStream(c,a)});